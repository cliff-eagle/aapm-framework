{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aapm-framework.dev/schemas/persona.schema.json",
  "title": "AAPM Persona Schema",
  "description": "Defines a complete domain-specific deployment for the Autonomous Adaptive Pedagogical Matrix. Version 3.0.0.",
  "type": "object",
  "required": [
    "schema_version",
    "persona"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "enum": [
        "1.0.0",
        "2.0.0",
        "3.0.0"
      ],
      "description": "Schema version — must match a registered version in migrations.ts"
    },
    "persona": {
      "type": "object",
      "required": [
        "id",
        "name",
        "learner_profile",
        "vocabulary_matrix",
        "companion",
        "environment",
        "evaluation"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique kebab-case identifier for this persona"
        },
        "name": {
          "type": "string",
          "description": "Human-readable persona name"
        },
        "description": {
          "type": "string",
          "description": "Brief description of the domain and target learner"
        },
        "learner_profile": {
          "type": "object",
          "required": [
            "native_language",
            "target_languages",
            "proficiency_baseline",
            "domain",
            "objective"
          ],
          "properties": {
            "native_language": {
              "type": "string",
              "pattern": "^[a-z]{2}$",
              "description": "ISO 639-1 language code"
            },
            "target_languages": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-z]{2}$"
              },
              "minItems": 1,
              "description": "Target languages (ISO 639-1 codes)"
            },
            "proficiency_baseline": {
              "type": "string",
              "enum": [
                "A1",
                "A2",
                "B1",
                "B2",
                "C1",
                "C2"
              ],
              "description": "Starting CEFR proficiency level"
            },
            "domain": {
              "type": "string",
              "description": "Professional or lifestyle domain"
            },
            "objective": {
              "type": "string",
              "description": "What fluency means for this learner — the outcome they're paying for"
            },
            "timeline": {
              "type": "string",
              "description": "Optional deadline or timeline for the learner's objective"
            }
          }
        },
        "vocabulary_matrix": {
          "type": "object",
          "required": [
            "domains"
          ],
          "properties": {
            "domains": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/vocabulary_domain"
              },
              "minItems": 1,
              "description": "Domain-specific vocabulary categories"
            },
            "cefr_annotations": {
              "type": "boolean",
              "default": true,
              "description": "Whether vocabulary items include CEFR level annotations"
            },
            "excluded_generic": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Generic vocabulary categories to deprioritize (e.g., 'colors', 'animals')"
            }
          }
        },
        "companion": {
          "type": "object",
          "required": [
            "name",
            "personality",
            "backstory"
          ],
          "properties": {
            "name": {
              "type": "string",
              "description": "The companion's name — should feel culturally appropriate"
            },
            "personality": {
              "type": "string",
              "description": "Personality traits and communication style"
            },
            "backstory": {
              "type": "string",
              "description": "The companion's personal history with both languages/cultures"
            },
            "shared_interests": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Interests shared with the learner for rapport building"
            },
            "cultural_bridge": {
              "type": "string",
              "description": "How the companion bridges the learner's L1 and L2 cultures"
            },
            "relationship_seed": {
              "type": "string",
              "description": "How the companion and learner 'met' — the relationship origin story"
            }
          }
        },
        "environment": {
          "type": "object",
          "required": [
            "tier_2",
            "tier_3"
          ],
          "properties": {
            "tier_2": {
              "type": "object",
              "required": [
                "setting",
                "locations",
                "npc_roster"
              ],
              "properties": {
                "setting": {
                  "type": "string",
                  "description": "Description of the Tier 2 social world"
                },
                "locations": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/location"
                  },
                  "minItems": 3,
                  "description": "Tier 2 locations where interactions occur"
                },
                "npc_roster": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/npc"
                  },
                  "minItems": 3,
                  "description": "NPCs populating Tier 2 locations"
                },
                "cultural_parameters": {
                  "$ref": "#/definitions/cultural_parameters"
                },
                "cultural_norms": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/cultural_norm"
                  },
                  "description": "Cultural norms enforced by NPCs with reputation consequences"
                }
              }
            },
            "tier_3": {
              "type": "object",
              "required": [
                "scenarios"
              ],
              "properties": {
                "scenarios": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/scenario"
                  },
                  "minItems": 2,
                  "description": "High-stakes scenarios with authority dynamics"
                }
              }
            },
            "adaptive_pressure": {
              "type": "object",
              "properties": {
                "tier_1": {
                  "$ref": "#/definitions/adaptive_pressure_config"
                },
                "tier_2": {
                  "$ref": "#/definitions/adaptive_pressure_config"
                },
                "tier_3": {
                  "$ref": "#/definitions/adaptive_pressure_config"
                }
              },
              "description": "Per-tier communicative pressure calibration configuration"
            }
          }
        },
        "retention_profile": {
          "type": "object",
          "properties": {
            "default_style": {
              "type": "string",
              "enum": [
                "gamified-coercion",
                "organic-social",
                "professional-urgency",
                "intrinsic-mastery",
                "social-accountability"
              ],
              "description": "Default Axis Z retention profile to suggest during onboarding"
            },
            "async_triggers": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/async_trigger"
              },
              "description": "Pre-configured async engagement triggers for this domain"
            }
          }
        },
        "evaluation": {
          "type": "object",
          "required": [
            "tier_2_success",
            "tier_3_success",
            "primary_metric"
          ],
          "properties": {
            "tier_2_success": {
              "type": "string",
              "description": "What constitutes Tier 2 success for this domain"
            },
            "tier_3_success": {
              "type": "string",
              "description": "What constitutes Tier 3 mastery for this domain"
            },
            "primary_metric": {
              "type": "string",
              "enum": [
                "task-completion-rate",
                "comprehensibility-score",
                "register-accuracy-score",
                "negotiation-success-rate",
                "code-switch-reduction-rate"
              ],
              "description": "The single most important metric for this domain"
            },
            "rubrics": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/evaluation_rubric"
              },
              "description": "Custom evaluation rubrics for Tier 3 scenarios"
            },
            "cultural_intelligence_weight": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "default": 0.15,
              "description": "Weight of CQ assessment in overall evaluation (0.0-1.0)"
            },
            "lexical_availability_tracking": {
              "type": "boolean",
              "default": true,
              "description": "Whether to track vocabulary retrieval speed as a fluency metric"
            }
          }
        }
      }
    },
    "input_modalities": {
      "type": "object",
      "description": "Multimodal input configuration — which input types the simulation accepts",
      "properties": {
        "text": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true
            },
            "default_language": {
              "type": "string",
              "description": "L1 or L2"
            }
          }
        },
        "audio": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "phoneme_engine": {
              "type": "string",
              "enum": [
                "wav2vec2",
                "azure-speech",
                "whisper",
                "deepgram"
              ],
              "description": "ASR / phoneme alignment backend"
            },
            "fallback": {
              "type": "string",
              "default": "text-only"
            }
          }
        },
        "visual": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "scene_descriptor_format": {
              "type": "string",
              "enum": [
                "json",
                "yaml",
                "natural-language"
              ],
              "default": "json"
            },
            "fallback": {
              "type": "string",
              "default": "text-description"
            }
          }
        }
      }
    },
    "world_state": {
      "type": "object",
      "description": "World Engine configuration — governs Tier 2 immersive environment",
      "properties": {
        "location_graph": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "id",
              "name"
            ],
            "properties": {
              "id": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "connections": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "IDs of connected locations"
              },
              "type": {
                "type": "string",
                "enum": [
                  "public",
                  "private",
                  "commercial",
                  "institutional"
                ]
              }
            }
          }
        },
        "time_system": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "day_length_minutes": {
              "type": "number",
              "minimum": 1
            }
          }
        },
        "ambient_events": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "id",
              "trigger"
            ],
            "properties": {
              "id": {
                "type": "string"
              },
              "trigger": {
                "type": "string",
                "enum": [
                  "time-based",
                  "reputation-gated",
                  "random",
                  "quest-triggered"
                ]
              },
              "npc_reactions": {
                "type": "object"
              }
            }
          }
        }
      }
    },
    "character_control": {
      "type": "object",
      "description": "Character controllability configuration",
      "properties": {
        "player_character": {
          "type": "object",
          "properties": {
            "control_mode": {
              "type": "string",
              "enum": [
                "full",
                "choice-tree",
                "voice"
              ],
              "default": "full"
            }
          }
        },
        "npc_autonomy_level": {
          "type": "string",
          "enum": [
            "scripted",
            "semi-autonomous",
            "fully-autonomous"
          ],
          "default": "fully-autonomous"
        },
        "hybrid_npcs": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "id"
            ],
            "properties": {
              "id": {
                "type": "string"
              },
              "player_can_possess": {
                "type": "boolean",
                "default": false
              },
              "takeover_trigger": {
                "type": "string",
                "enum": [
                  "manual",
                  "affective-threshold",
                  "educator-assigned"
                ]
              }
            }
          }
        }
      }
    },
    "curriculum_delivery": {
      "type": "object",
      "description": "Micro-curriculum delivery format configuration",
      "properties": {
        "preferred_format": {
          "type": "string",
          "enum": [
            "slideshow",
            "video",
            "flashcards",
            "podcast",
            "debrief",
            "auto"
          ],
          "default": "auto"
        },
        "auto_select_by": {
          "type": "string",
          "enum": [
            "retention_profile",
            "session_length",
            "affective_state"
          ],
          "default": "retention_profile"
        }
      }
    }
  },
  "definitions": {
    "vocabulary_domain": {
      "type": "object",
      "required": [
        "name",
        "priority",
        "items"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Domain category name (e.g., 'tactical-vocabulary', 'medical-terminology')"
        },
        "priority": {
          "type": "string",
          "enum": [
            "critical",
            "important",
            "supplementary"
          ],
          "description": "How essential this vocabulary is for the learner's objective"
        },
        "items": {
          "type": "array",
          "items": {
            "oneOf": [
              {
                "type": "string"
              },
              {
                "type": "object",
                "required": [
                  "term"
                ],
                "properties": {
                  "term": {
                    "type": "string"
                  },
                  "cefr": {
                    "type": "string",
                    "enum": [
                      "A1",
                      "A2",
                      "B1",
                      "B2",
                      "C1",
                      "C2"
                    ]
                  },
                  "register": {
                    "type": "string",
                    "enum": [
                      "informal",
                      "neutral",
                      "formal",
                      "technical"
                    ]
                  },
                  "context": {
                    "type": "string",
                    "description": "When/where this term is used"
                  }
                }
              }
            ]
          },
          "minItems": 1,
          "description": "Vocabulary items — can be simple strings or annotated objects"
        },
        "hierarchy": {
          "type": "string",
          "description": "Social context this vocabulary is used in (e.g., 'with-coaches', 'with-media')"
        },
        "emotional_register": {
          "type": "string",
          "enum": [
            "neutral",
            "high-stakes",
            "intimate",
            "adversarial"
          ],
          "description": "Emotional weight of this vocabulary category"
        }
      }
    },
    "location": {
      "type": "object",
      "required": [
        "id",
        "name"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique kebab-case identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable location name"
        },
        "description": {
          "type": "string",
          "description": "Description of the location and its social character"
        },
        "npc_ids": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "NPC IDs available at this location"
        },
        "typical_tasks": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Communicative tasks that naturally occur here"
        },
        "vocabulary_focus": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Vocabulary domains most relevant at this location"
        }
      }
    },
    "npc": {
      "type": "object",
      "required": [
        "id",
        "name",
        "role",
        "register"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique kebab-case identifier"
        },
        "name": {
          "type": "string",
          "description": "Character name"
        },
        "role": {
          "type": "string",
          "description": "Social role (e.g., 'head-coach', 'café-owner', 'receptionist')"
        },
        "tier": {
          "type": "integer",
          "enum": [
            2,
            3
          ],
          "description": "Primary tier this NPC appears in"
        },
        "register": {
          "type": "string",
          "description": "Default register level ('informal', 'neutral', 'formal', 'mixed')"
        },
        "personality": {
          "type": "string",
          "description": "Personality description for prompt injection"
        },
        "location_ids": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Locations where this NPC can be found"
        },
        "vocabulary_focus": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Vocabulary domains this NPC naturally uses"
        },
        "initial_reputation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "default": 0,
          "description": "Starting reputation score (default: 0 neutral)"
        },
        "openness_enabled": {
          "type": "boolean",
          "default": false,
          "description": "Whether this NPC uses the Tier 3 openness mechanic"
        },
        "personality_model": {
          "$ref": "#/definitions/npc_personality_model",
          "description": "Big Five personality traits and cultural overlay for behavioral authenticity"
        },
        "consistency_constraints": {
          "type": "object",
          "properties": {
            "verbal_tics": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Speech patterns that persist regardless of mood"
            },
            "prohibited_behaviors": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Actions this NPC would never take"
            },
            "mandatory_behaviors": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Actions this NPC always performs"
            }
          }
        }
      }
    },
    "scenario": {
      "type": "object",
      "required": [
        "id",
        "type",
        "authority_npc_id",
        "stakes",
        "objectives"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$"
        },
        "type": {
          "type": "string",
          "description": "Scenario type (e.g., 'contract-negotiation', 'press-conference')"
        },
        "description": {
          "type": "string"
        },
        "authority_npc_id": {
          "type": "string",
          "description": "NPC ID of the authority figure"
        },
        "stakes": {
          "type": "string",
          "description": "What's at stake — the consequence of failure"
        },
        "objectives": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "What the learner must achieve in this scenario"
        },
        "evaluation_weight": {
          "type": "object",
          "properties": {
            "linguistic_accuracy": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "pragmatic_appropriateness": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "register_alignment": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "cultural_intelligence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          },
          "description": "Weight distribution for evaluation dimensions (must sum to 1.0)"
        },
        "register_requirements": {
          "type": "string",
          "description": "What register is expected (e.g., 'professional-formal', 'diplomatic')"
        }
      }
    },
    "async_trigger": {
      "type": "object",
      "required": [
        "type",
        "sender_npc_id"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "npc-message",
            "companion-check-in",
            "scenario-preview",
            "achievement-alert",
            "streak-reminder",
            "deadline-countdown",
            "challenge-unlock",
            "peer-update",
            "curriculum-ready",
            "pronunciation-drill"
          ]
        },
        "sender_npc_id": {
          "type": "string",
          "description": "NPC who sends this trigger (must exist in npc_roster or companion)"
        },
        "frequency": {
          "type": "string",
          "enum": [
            "daily",
            "every-2-days",
            "weekly",
            "on-churn-risk"
          ],
          "description": "How often this trigger fires"
        },
        "template": {
          "type": "string",
          "description": "Message template with {{variables}}"
        }
      }
    },
    "evaluation_rubric": {
      "type": "object",
      "required": [
        "scenario_id",
        "pass_threshold"
      ],
      "properties": {
        "scenario_id": {
          "type": "string",
          "description": "Which scenario this rubric evaluates"
        },
        "pass_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum composite score for passing"
        },
        "distinction_threshold": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum composite score for distinction"
        },
        "criteria": {
          "type": "object",
          "properties": {
            "linguistic_accuracy": {
              "type": "string"
            },
            "pragmatic_appropriateness": {
              "type": "string"
            },
            "register_alignment": {
              "type": "string"
            },
            "cultural_intelligence": {
              "type": "string"
            }
          },
          "description": "Per-dimension rubric descriptions"
        }
      }
    },
    "cultural_parameters": {
      "type": "object",
      "properties": {
        "greeting_norms": {
          "type": "string",
          "description": "How people greet in this culture/context"
        },
        "formality_system": {
          "type": "string",
          "description": "How formality works (e.g., 'tu/vous', 'tú/usted', Japanese keigo)"
        },
        "register_markers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "register": {
                "type": "string"
              },
              "markers": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          },
          "description": "Linguistic markers that signal each register level"
        },
        "taboo_topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Topics to avoid in certain contexts"
        },
        "naming_conventions": {
          "type": "string",
          "description": "How to address people (first name, surname, title)"
        },
        "gesture_appropriateness": {
          "type": "string",
          "description": "Notes on physical gesture norms"
        }
      }
    },
    "npc_personality_model": {
      "type": "object",
      "properties": {
        "openness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Curiosity, willingness to engage unusual topics"
        },
        "conscientiousness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Reliability, attention to detail"
        },
        "extraversion": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Talkativeness, social energy"
        },
        "agreeableness": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Patience, helpfulness, error tolerance"
        },
        "neuroticism": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Emotional reactivity, social friction sensitivity"
        },
        "cultural_overlay": {
          "type": "object",
          "properties": {
            "communicative_directness": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "formality_default": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "power_distance_sensitivity": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "emotional_expressiveness": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        }
      }
    },
    "cultural_norm": {
      "type": "object",
      "required": [
        "id",
        "domain",
        "appropriate_behavior"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$"
        },
        "domain": {
          "type": "string",
          "enum": [
            "greeting",
            "dining",
            "business",
            "social",
            "religious",
            "family",
            "public-space",
            "gift-giving",
            "conversation-topic"
          ],
          "description": "Cultural domain this norm belongs to"
        },
        "appropriate_behavior": {
          "type": "string",
          "description": "Description of the culturally appropriate behavior"
        },
        "common_violations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "l1_culture": {
                "type": "string"
              },
              "violation": {
                "type": "string"
              },
              "frequency": {
                "type": "string",
                "enum": [
                  "common",
                  "occasional",
                  "rare"
                ]
              }
            }
          },
          "description": "Common violations by L1 culture"
        },
        "reputation_impact": {
          "type": "number",
          "minimum": -1,
          "maximum": 0,
          "description": "Reputation delta upon violation (always negative)"
        },
        "applicable_tiers": {
          "type": "array",
          "items": {
            "type": "integer",
            "enum": [
              1,
              2,
              3
            ]
          }
        }
      }
    },
    "adaptive_pressure_config": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "target_range": {
          "type": "object",
          "properties": {
            "min": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "max": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "adjustment_speed": {
          "type": "string",
          "enum": [
            "gradual",
            "responsive",
            "aggressive"
          ]
        },
        "use_affective_data": {
          "type": "boolean",
          "default": true
        }
      }
    }
  }
}